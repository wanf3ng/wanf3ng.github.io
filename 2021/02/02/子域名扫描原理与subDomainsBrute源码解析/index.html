<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="wanf3ng"><meta name="keywords" content="网络安全,晚风,wanf3ng"><meta name="description" content="为什么要扫描子域名有时候在渗透前，只给了一个主域名地址甚至只给了一家公司|机构的名字，如baidu.com，主域名的安全防护措施一般做的比较好，并且单从这一个主域名我们很难发现网站的漏洞。而子域名也属于目标的资产之一，为了扩大攻击面，我们可以对子域名上的网站进行渗透测试，从而挖掘出漏洞，拿下目标。 子域名扫描原理不知道多少小伙伴跟我一样，从一开始就对子域名扫描原理存在误解。一开始学会目录扫描之后，"><meta property="og:type" content="article"><meta property="og:title" content="子域名扫描原理与subDomainsBrute源码解析"><meta property="og:url" content="https://wanf3ng.github.io/2021/02/02/%E5%AD%90%E5%9F%9F%E5%90%8D%E6%89%AB%E6%8F%8F%E5%8E%9F%E7%90%86%E4%B8%8EsubDomainsBrute%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/index.html"><meta property="og:site_name" content="wanf3ng&#39;s blog"><meta property="og:description" content="为什么要扫描子域名有时候在渗透前，只给了一个主域名地址甚至只给了一家公司|机构的名字，如baidu.com，主域名的安全防护措施一般做的比较好，并且单从这一个主域名我们很难发现网站的漏洞。而子域名也属于目标的资产之一，为了扩大攻击面，我们可以对子域名上的网站进行渗透测试，从而挖掘出漏洞，拿下目标。 子域名扫描原理不知道多少小伙伴跟我一样，从一开始就对子域名扫描原理存在误解。一开始学会目录扫描之后，"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://th.wallhaven.cc/small/83/83z1qk.jpg"><meta property="article:published_time" content="2021-02-01T16:38:32.000Z"><meta property="article:modified_time" content="2022-05-20T06:14:28.000Z"><meta property="article:author" content="wanf3ng"><meta property="article:tag" content="安全工具"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://th.wallhaven.cc/small/83/83z1qk.jpg"><meta name="referrer" content="no-referrer-when-downgrade"><title>子域名扫描原理与subDomainsBrute源码解析 - wanf3ng&#39;s blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/custom.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"wanf3ng.github.io",root:"/",version:"1.9.5-a",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:"952845559a725a8f8506594fda37c635",google:{measurement_id:null},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>if(!Fluid.ctx.dnt){var _hmt=_hmt||[];!function(){var t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?952845559a725a8f8506594fda37c635";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()}</script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","")}))</script><meta name="generator" content="Hexo 6.3.0"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>晚风</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="子域名扫描原理与subDomainsBrute源码解析"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> wanf3ng </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-02-02 00:38" pubdate>2021年2月2日 凌晨</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 10k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 87 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">子域名扫描原理与subDomainsBrute源码解析</h1><div class="markdown-body"><h2 id="为什么要扫描子域名"><a href="#为什么要扫描子域名" class="headerlink" title="为什么要扫描子域名"></a>为什么要扫描子域名</h2><p>有时候在渗透前，只给了一个主域名地址甚至只给了一家公司|机构的名字，如<code>baidu.com</code>，主域名的安全防护措施一般做的比较好，并且单从这一个主域名我们很难发现网站的漏洞。而子域名也属于目标的资产之一，为了扩大攻击面，我们可以对子域名上的网站进行渗透测试，从而挖掘出漏洞，拿下目标。</p><h2 id="子域名扫描原理"><a href="#子域名扫描原理" class="headerlink" title="子域名扫描原理"></a>子域名扫描原理</h2><p>不知道多少小伙伴跟我一样，从一开始就对子域名扫描原理存在误解。一开始学会目录扫描之后，就以为子域名扫描和目录扫描的原理是一样的。也是对目标轮询来得到结果。后来才发现其实不然，最简单的子域名扫描只要轮询DNS服务器就可以得到结果，而无需直接请求目标服务器。</p><p>那么先来说一下轮询DNS服务器获取子域名的具体步骤。</p><p>这里使用了<code>aiodns</code>这个库作为演示，这个库支持协程异步查询，所以查询速度会比较快。下面是一个aiodns查询A记录的例子，非常简洁明了，看过前面协程文章的就应该看得懂，首先创建一个事件流和一个dns解析器，然后将查询函数加入到事件流中，等到完成整个dns查询后再取回结果。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> aiodns<br><br>loop = asyncio.get_event_loop()<br>resolver = aiodns.DNSResolver(loop=loop)<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">name, query_type</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> resolver.query(name, query_type)<br>    <br>coro = query(<span class="hljs-string">&#x27;baidu.com&#x27;</span>, <span class="hljs-string">&#x27;A&#x27;</span>)<br>result = loop.run_until_complete(coro)<br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">[&lt;ares_query_a_result&gt; host=<span class="hljs-number">220.181</span><span class="hljs-number">.38</span><span class="hljs-number">.148</span>, ttl=<span class="hljs-number">0</span>, &lt;ares_query_a_result&gt; host=<span class="hljs-number">39.156</span><span class="hljs-number">.69</span><span class="hljs-number">.79</span>, ttl=<span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure><h2 id="subDomainBrute源码分析"><a href="#subDomainBrute源码分析" class="headerlink" title="subDomainBrute源码分析"></a>subDomainBrute源码分析</h2><p>在说到子域名扫描工具时就不得不提到一位国人写的工具，虽然获取子域名的方式比较单一，即轮询DNS服务器判断子域名是否存在，并没有采用搜索引擎分析，也没有采用分析证书域得到子域名，但也不失为值得学习的好工具。</p><p>作者为Lijiejie，目前我分析的工具版本是1.4版本，也就是当前的最新版</p><p>我们先来看一下subDomainsBrute这个工具的文件目录</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs stylus">│  <span class="hljs-selector-class">.gitignore</span><br>│  README<span class="hljs-selector-class">.md</span><br>│  screenshot<span class="hljs-selector-class">.png</span><br>│  subDomainsBrute<span class="hljs-selector-class">.py</span><br>│  <br>├─dict<br>│      dns_servers<span class="hljs-selector-class">.txt</span><br>│      next_sub<span class="hljs-selector-class">.txt</span><br>│      next_sub_full<span class="hljs-selector-class">.txt</span><br>│      subnames<span class="hljs-selector-class">.txt</span><br>│      subnames_all_5_letters<span class="hljs-selector-class">.txt</span><br>│      subnames_full<span class="hljs-selector-class">.txt</span><br>│      <br>└─lib<br>        cmdline<span class="hljs-selector-class">.py</span><br>        common<span class="hljs-selector-class">.py</span><br>        common_py2<span class="hljs-selector-class">.py</span><br>        common_py3<span class="hljs-selector-class">.py</span><br>        consle_width<span class="hljs-selector-class">.py</span><br>        scanner_py2<span class="hljs-selector-class">.py</span><br>        scanner_py3<span class="hljs-selector-class">.py</span><br>        __init__.py<br></code></pre></td></tr></table></figure><p>可以很清晰看到，主文件只有一个subDomainsBrute.py，dict文件夹存放的是字典文件，lib文件夹存放依赖文件。而我们使用的是Python3，所以只需分析主文件subDomainsBrute.py和lib中的cmdline.py、common.py、common_py3.py、consle_width.py和scanner_py3.py即可，Python2版本的文件也大同小异。</p><h3 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h3><p>首先我们从主文件subDomainsBrute.py入手。这个文件主要是做一些整体的函数调用。</p><p>如在主线程检测用户的中断：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">run_process</span>(<span class="hljs-params">*params</span>):<br>    signal.signal(signal.SIGINT, user_abort) <span class="hljs-comment"># 检测来自键盘的中断 Ctrl+C</span><br>    s = SubNameBrute(*params)<br>    s.run()<br><br></code></pre></td></tr></table></figure><p>定义一些初始化变量：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 加载可用的dns服务器</span><br>dns_servers = load_dns_servers()<br><span class="hljs-comment"># 加载子域名</span><br>next_subs = load_next_sub(options)<br><span class="hljs-comment"># 初始化扫描数</span><br>scan_count = multiprocessing.Value(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-number">0</span>)<br><span class="hljs-comment"># 初始化发现数</span><br>found_count = multiprocessing.Value(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-number">0</span>)<br><span class="hljs-comment"># 初始化进程队列长度，就是进程数</span><br>queue_size_array = multiprocessing.Array(<span class="hljs-string">&#x27;i&#x27;</span>, options.process)<br></code></pre></td></tr></table></figure><p>多进程实现程序并发扫描：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> process_num <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(options.process):<br>    p = multiprocessing.Process(target=run_process,<br>                                args=(domain, options, process_num, dns_servers, next_subs,<br>                                      scan_count, found_count, queue_size_array, tmp_dir)<br>                                )<br>    all_process.append(p)<br>    p.start()<br></code></pre></td></tr></table></figure><p>以及扫描结果的输出与写入：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(out_file_name, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    <span class="hljs-keyword">for</span> _file <span class="hljs-keyword">in</span> glob.glob(tmp_dir + <span class="hljs-string">&#x27;/*.txt&#x27;</span>):<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(_file, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> tmp_f:<br>            <span class="hljs-keyword">for</span> domain <span class="hljs-keyword">in</span> tmp_f:<br>                <span class="hljs-keyword">if</span> domain <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> all_domains:<br>                    domain_count += <span class="hljs-number">1</span><br>                    all_domains.add(domain)       <span class="hljs-comment"># cname query can result in duplicated domains</span><br>                    f.write(domain)<br></code></pre></td></tr></table></figure><h3 id="公共函数"><a href="#公共函数" class="headerlink" title="公共函数"></a>公共函数</h3><p>接下来我们分析一下公共函数模块common_py3.py中的函数</p><p><code>test_server_python3</code>这个函数首先用正确的域名去测试一台DNS能不能发出正确的响应，其次用一个错误的域名去测试DNS，看能不能得到响应，如果不存在的域名也能被解析，则说明从这台DNS服务器得到的数据也是不可靠的。这点细节做的比较好，有些扫描器只检测DNS服务器能不能给出正确的响应，而不进行错误检测。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_server_python3</span>(<span class="hljs-params">server, dns_servers</span>):<br>    resolver = aiodns.DNSResolver()<br>    <span class="hljs-keyword">try</span>: <span class="hljs-comment"># 测试dns服务器是否能得到正确的响应</span><br>        resolver.nameservers = [server]<br>        answers = <span class="hljs-keyword">await</span> resolver.query(<span class="hljs-string">&#x27;public-dns-a.baidu.com&#x27;</span>, <span class="hljs-string">&#x27;A&#x27;</span>)    <span class="hljs-comment"># an existed domain</span><br>        <span class="hljs-keyword">if</span> answers[<span class="hljs-number">0</span>].host != <span class="hljs-string">&#x27;180.76.76.76&#x27;</span>:<br>            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Incorrect DNS response&#x27;</span>)<br>        <span class="hljs-keyword">try</span>: <span class="hljs-comment"># 测试服务器对错误域名的解析能力，如果不存在的域名也能解析成功，这样的DNS服务器不可靠，是无法使用的</span><br>            <span class="hljs-keyword">await</span> resolver.query(<span class="hljs-string">&#x27;test.bad.dns.lijiejie.com&#x27;</span>, <span class="hljs-string">&#x27;A&#x27;</span>)    <span class="hljs-comment"># non-existed domain</span><br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;bad_dns_servers.txt&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>                f.write(server + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>            print_msg(<span class="hljs-string">&#x27;[+] Bad DNS Server found %s&#x27;</span> % server)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-comment"># 两个测试都通过就加入到可用dns服务器列表</span><br>            dns_servers.append(server)<br>        print_msg(<span class="hljs-string">&#x27;[+] Server %s &lt; OK &gt;   Found %s&#x27;</span> % (server.ljust(<span class="hljs-number">16</span>), <span class="hljs-built_in">len</span>(dns_servers)))<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        print_msg(<span class="hljs-string">&#x27;[+] Server %s &lt;Fail&gt;   Found %s&#x27;</span> % (server.ljust(<span class="hljs-number">16</span>), <span class="hljs-built_in">len</span>(dns_servers)))<br></code></pre></td></tr></table></figure><p>加载dns服务器和字典文件就不说了，太简单了，直接读文件就可以</p><p>接下来是<code>async_wildcard_test</code>这个函数，用于泛解析域名的检测。我们知道，如果一个域名为泛解析域名，那么不管我们查询任何的子域名，都会被成功解析并正确响应。这里的识别办法是，通过查询一个几乎不可能存在的子域名<code>lijiejie-not-existed-test</code>，如果得到了响应，那就说明这个域名是做了泛解析。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 异步泛解析检查，有的域名能解析任意域名</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">async_wildcard_test</span>(<span class="hljs-params">domain, dns_servers, level=<span class="hljs-number">1</span></span>):<br>    <span class="hljs-keyword">try</span>:<br>        r = aiodns.DNSResolver()<br>        r.nameservers = dns_servers<br>        answers = <span class="hljs-keyword">await</span> r.query(<span class="hljs-string">&#x27;lijiejie-not-existed-test.%s&#x27;</span> % domain, <span class="hljs-string">&#x27;A&#x27;</span>)<br>        ips = <span class="hljs-string">&#x27;, &#x27;</span>.join(<span class="hljs-built_in">sorted</span>([answer.host <span class="hljs-keyword">for</span> answer <span class="hljs-keyword">in</span> answers]))<br>        <span class="hljs-keyword">if</span> level == <span class="hljs-number">1</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;any-sub.%s\t%s&#x27;</span> % (domain.ljust(<span class="hljs-number">30</span>), ips))<br>            <span class="hljs-keyword">await</span> async_wildcard_test(<span class="hljs-string">&#x27;any-sub.%s&#x27;</span> % domain, dns_servers, <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">elif</span> level == <span class="hljs-number">2</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\nUse -w to enable force scan wildcard domain&#x27;</span>)<br>            sys.exit(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> domain<br></code></pre></td></tr></table></figure><h3 id="核心模块——扫描"><a href="#核心模块——扫描" class="headerlink" title="核心模块——扫描"></a>核心模块——扫描</h3><p>接下来就是对这个项目中最核心的部分——扫描部分<code>scanner_py3.py</code>进行源码分析</p><p>整个文件其实就一个类<code>SubNameBrute</code>，里面有两个函数分别是<code>load_sub_names()</code>和<code>scan()</code>，结构很清晰，前者从字典中加载子域名，后者负责轮询扫描</p><p>看得出来，先从子域名字典中读取子域名添加进变量<code>normal_lines</code>，然后对全量暴力破解（如无脑五位a-z而不是根据常用关键字如www、vpn）添加进变量<code>wildcard_lines</code>，当然中间还有一些去重之类的操作就不细说了。最后是手动为每个进程的队列分配的任务量，感觉其实duck不必，直接用进程池就可以搞定了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_sub_names</span>(<span class="hljs-params">self</span>):<br>    normal_lines = []<br>    wildcard_lines = []<br>    wildcard_set = <span class="hljs-built_in">set</span>()<br>    regex_list = []<br>    lines = <span class="hljs-built_in">set</span>()<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.options.file) <span class="hljs-keyword">as</span> inFile:<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> inFile.readlines():<br>            sub = line.strip()<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> sub <span class="hljs-keyword">or</span> sub <span class="hljs-keyword">in</span> lines:<br>                <span class="hljs-keyword">continue</span><br>            lines.add(sub)<br><br>            brace_count = sub.count(<span class="hljs-string">&#x27;&#123;&#x27;</span>)<br>            <span class="hljs-keyword">if</span> brace_count &gt; <span class="hljs-number">0</span>:<br>                wildcard_lines.append((brace_count, sub))<br>                sub = sub.replace(<span class="hljs-string">&#x27;&#123;alphnum&#125;&#x27;</span>, <span class="hljs-string">&#x27;[a-z0-9]&#x27;</span>)<br>                sub = sub.replace(<span class="hljs-string">&#x27;&#123;alpha&#125;&#x27;</span>, <span class="hljs-string">&#x27;[a-z]&#x27;</span>)<br>                sub = sub.replace(<span class="hljs-string">&#x27;&#123;num&#125;&#x27;</span>, <span class="hljs-string">&#x27;[0-9]&#x27;</span>)<br>                <span class="hljs-keyword">if</span> sub <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> wildcard_set:<br>                    wildcard_set.add(sub)<br>                    regex_list.append(<span class="hljs-string">&#x27;^&#x27;</span> + sub + <span class="hljs-string">&#x27;$&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                normal_lines.append(sub)<br>                self.normal_names_set.add(sub)<br><br>    <span class="hljs-keyword">if</span> regex_list:<br>        pattern = <span class="hljs-string">&#x27;|&#x27;</span>.join(regex_list)<br>        _regex = re.<span class="hljs-built_in">compile</span>(pattern)<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> normal_lines:<br>            <span class="hljs-keyword">if</span> _regex.search(line):<br>                normal_lines.remove(line)<br><br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> normal_lines[self.process_num::self.options.process]:<br>        <span class="hljs-keyword">await</span> self.queue.put((<span class="hljs-number">0</span>, _))    <span class="hljs-comment"># priority set to 0</span><br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> wildcard_lines[self.process_num::self.options.process]:<br>        <span class="hljs-keyword">await</span> self.queue.put(_)<br></code></pre></td></tr></table></figure><p>最后就是<code>scan()</code>函数的分析：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">scan</span>(<span class="hljs-params">self, j</span>):<br>    self.resolvers[j].nameservers = [self.dns_servers[j % self.dns_count]]<br>    <span class="hljs-keyword">if</span> self.dns_count &gt; <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            s = random.choice(self.resolvers)<br>            <span class="hljs-keyword">if</span> s != self.dns_servers[j % self.dns_count]:<br>                self.resolvers[j].nameservers.append(s)<br>                <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">if</span> time.time() - self.count_time &gt; <span class="hljs-number">1.0</span>:<br>                <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.lock:<br>                    self.scan_count.value += self.scan_count_local<br>                    self.scan_count_local = <span class="hljs-number">0</span><br>                    self.queue_size_array[self.process_num] = self.queue.qsize()<br>                    <span class="hljs-keyword">if</span> self.found_count_local:<br>                        self.found_count.value += self.found_count_local<br>                        self.found_count_local = <span class="hljs-number">0</span><br>                    self.count_time = time.time()<br><br>            <span class="hljs-keyword">try</span>:<br>                brace_count, sub = self.queue.get_nowait()<br>                self.threads_status[j] = <span class="hljs-string">&#x27;1&#x27;</span><br>            <span class="hljs-keyword">except</span> asyncio.queues.QueueEmpty <span class="hljs-keyword">as</span> e:<br>                self.threads_status[j] = <span class="hljs-string">&#x27;0&#x27;</span><br>                <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.5</span>)<br>                <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.threads_status:<br>                    <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> brace_count &gt; <span class="hljs-number">0</span>:<br>                brace_count -= <span class="hljs-number">1</span><br>                <span class="hljs-keyword">if</span> sub.find(<span class="hljs-string">&#x27;&#123;next_sub&#125;&#x27;</span>) &gt;= <span class="hljs-number">0</span>:<br>                    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> self.next_subs:<br>                        <span class="hljs-keyword">await</span> self.queue.put((<span class="hljs-number">0</span>, sub.replace(<span class="hljs-string">&#x27;&#123;next_sub&#125;&#x27;</span>, _)))<br>                <span class="hljs-keyword">if</span> sub.find(<span class="hljs-string">&#x27;&#123;alphnum&#125;&#x27;</span>) &gt;= <span class="hljs-number">0</span>:<br>                    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789&#x27;</span>:<br>                        <span class="hljs-keyword">await</span> self.queue.put((brace_count, sub.replace(<span class="hljs-string">&#x27;&#123;alphnum&#125;&#x27;</span>, _, <span class="hljs-number">1</span>)))<br>                <span class="hljs-keyword">elif</span> sub.find(<span class="hljs-string">&#x27;&#123;alpha&#125;&#x27;</span>) &gt;= <span class="hljs-number">0</span>:<br>                    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span>:<br>                        <span class="hljs-keyword">await</span> self.queue.put((brace_count, sub.replace(<span class="hljs-string">&#x27;&#123;alpha&#125;&#x27;</span>, _, <span class="hljs-number">1</span>)))<br>                <span class="hljs-keyword">elif</span> sub.find(<span class="hljs-string">&#x27;&#123;num&#125;&#x27;</span>) &gt;= <span class="hljs-number">0</span>:<br>                    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;0123456789&#x27;</span>:<br>                        <span class="hljs-keyword">await</span> self.queue.put((brace_count, sub.replace(<span class="hljs-string">&#x27;&#123;num&#125;&#x27;</span>, _, <span class="hljs-number">1</span>)))<br>                <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">import</span> traceback<br>            <span class="hljs-built_in">print</span>(traceback.format_exc())<br>            <span class="hljs-keyword">break</span><br><br>        <span class="hljs-keyword">try</span>:<br><br>            <span class="hljs-keyword">if</span> sub <span class="hljs-keyword">in</span> self.found_subs:<br>                <span class="hljs-keyword">continue</span><br><br>            self.scan_count_local += <span class="hljs-number">1</span><br>            cur_domain = sub + <span class="hljs-string">&#x27;.&#x27;</span> + self.domain<br>            <span class="hljs-comment"># print(&#x27;Query %s&#x27; % cur_domain)</span><br>            answers = <span class="hljs-keyword">await</span> self.resolvers[j].query(cur_domain, <span class="hljs-string">&#x27;A&#x27;</span>)<br><br>            <span class="hljs-keyword">if</span> answers:<br>                self.found_subs.add(sub)<br>                ips = <span class="hljs-string">&#x27;, &#x27;</span>.join(<span class="hljs-built_in">sorted</span>([answer.host <span class="hljs-keyword">for</span> answer <span class="hljs-keyword">in</span> answers]))<br>                <span class="hljs-keyword">if</span> ips <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;1.1.1.1&#x27;</span>, <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, <span class="hljs-string">&#x27;0.0.0.1&#x27;</span>]:<br>                    <span class="hljs-keyword">continue</span><br>                <span class="hljs-keyword">if</span> self.options.i <span class="hljs-keyword">and</span> is_intranet(answers[<span class="hljs-number">0</span>].host):<br>                    <span class="hljs-keyword">continue</span><br><br>                <span class="hljs-keyword">try</span>:<br>                    self.scan_count_local += <span class="hljs-number">1</span><br>                    answers = <span class="hljs-keyword">await</span> self.resolvers[j].query(cur_domain, <span class="hljs-string">&#x27;CNAME&#x27;</span>)<br>                    cname = answers[<span class="hljs-number">0</span>].target.to_unicode().rstrip(<span class="hljs-string">&#x27;.&#x27;</span>)<br>                    <span class="hljs-keyword">if</span> cname.endswith(self.domain) <span class="hljs-keyword">and</span> cname <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.found_subs:<br>                        cname_sub = cname[:<span class="hljs-built_in">len</span>(cname) - <span class="hljs-built_in">len</span>(self.domain) - <span class="hljs-number">1</span>]    <span class="hljs-comment"># new sub</span><br>                        <span class="hljs-keyword">if</span> cname_sub <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.normal_names_set:<br>                            self.found_subs.add(cname)<br>                            <span class="hljs-keyword">await</span> self.queue.put((<span class="hljs-number">0</span>, cname_sub))<br>                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                    <span class="hljs-keyword">pass</span><br><br>                first_level_sub = sub.split(<span class="hljs-string">&#x27;.&#x27;</span>)[-<span class="hljs-number">1</span>]<br>                max_found = <span class="hljs-number">20</span><br><br>                <span class="hljs-keyword">if</span> self.options.w:<br>                    first_level_sub = <span class="hljs-string">&#x27;&#x27;</span><br>                    max_found = <span class="hljs-number">3</span><br><br>                <span class="hljs-keyword">if</span> (first_level_sub, ips) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.ip_dict:<br>                    self.ip_dict[(first_level_sub, ips)] = <span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:<br>                    self.ip_dict[(first_level_sub, ips)] += <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">if</span> self.ip_dict[(first_level_sub, ips)] &gt; max_found:<br>                        <span class="hljs-keyword">continue</span><br><br>                self.found_count_local += <span class="hljs-number">1</span><br><br>                self.outfile.write(cur_domain.ljust(<span class="hljs-number">30</span>) + <span class="hljs-string">&#x27;\t&#x27;</span> + ips + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>                self.outfile.flush()<br>                <span class="hljs-keyword">try</span>:<br>                    self.scan_count_local += <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">await</span> self.resolvers[j].query(<span class="hljs-string">&#x27;lijiejie-test-not-existed.&#x27;</span> + cur_domain, <span class="hljs-string">&#x27;A&#x27;</span>)<br>                <span class="hljs-keyword">except</span> aiodns.error.DNSError <span class="hljs-keyword">as</span> e:<br>                    <span class="hljs-keyword">if</span> e.args[<span class="hljs-number">0</span>] <span class="hljs-keyword">in</span> [<span class="hljs-number">4</span>]:<br>                        <span class="hljs-keyword">if</span> self.queue.qsize() &lt; <span class="hljs-number">50000</span>:<br>                            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> self.next_subs:<br>                                <span class="hljs-keyword">await</span> self.queue.put((<span class="hljs-number">0</span>, _ + <span class="hljs-string">&#x27;.&#x27;</span> + sub))<br>                        <span class="hljs-keyword">else</span>:<br>                            <span class="hljs-keyword">await</span> self.queue.put((<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;&#123;next_sub&#125;.&#x27;</span> + sub))<br>                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                    <span class="hljs-keyword">pass</span><br><br>        <span class="hljs-keyword">except</span> aiodns.error.DNSError <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">if</span> e.args[<span class="hljs-number">0</span>] <span class="hljs-keyword">in</span> [<span class="hljs-number">1</span>, <span class="hljs-number">4</span>]:<br>                <span class="hljs-keyword">pass</span><br>            <span class="hljs-keyword">elif</span> e.args[<span class="hljs-number">0</span>] <span class="hljs-keyword">in</span> [<span class="hljs-number">11</span>, <span class="hljs-number">12</span>]:   <span class="hljs-comment"># 12 timeout   # (11, &#x27;Could not contact DNS servers&#x27;)</span><br>                <span class="hljs-comment"># print(&#x27;timed out sub %s&#x27; % sub)</span><br>                self.timeout_subs[sub] = self.timeout_subs.get(sub, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span><br>                <span class="hljs-keyword">if</span> self.timeout_subs[sub] &lt;= <span class="hljs-number">1</span>:<br>                    <span class="hljs-keyword">await</span> self.queue.put((<span class="hljs-number">0</span>, sub))  <span class="hljs-comment"># Retry</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(e)<br>        <span class="hljs-keyword">except</span> asyncio.TimeoutError <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">pass</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">import</span> traceback<br>            traceback.print_exc()<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;errors.log&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>) <span class="hljs-keyword">as</span> errFile:<br>                errFile.write(<span class="hljs-string">&#x27;[%s] %s\n&#x27;</span> % (<span class="hljs-built_in">type</span>(e), <span class="hljs-built_in">str</span>(e)))<br></code></pre></td></tr></table></figure><p>首先是随机选择了一个DNS解析器，然后的一大段代码都在处理a五位a-z的爆破。接下来就是正式的查询步骤</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">answers = <span class="hljs-keyword">await</span> self.resolvers[j].query(cur_domain, <span class="hljs-string">&#x27;A&#x27;</span>)<br></code></pre></td></tr></table></figure><p>通过这条语句使用aiodns查询了域名的A记录，如果有结果，再查询该域名的CNAME记录，从CNAME中反查出子域名加入到结果中。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">answers = <span class="hljs-keyword">await</span> self.resolvers[j].query(cur_domain, <span class="hljs-string">&#x27;CNAME&#x27;</span>)<br></code></pre></td></tr></table></figure><p>关于各种DNS查询类型，可以自己百度，这里就不做更多展开了。接下来似乎是在处理泛解析的问题，很迷惑这里怎么又写了一遍。最后就是在处理aiodns抛出的异常的代码，如DNS中没有对应的子域名，超时等问题。</p><p>总结一下subDomainBrute的整个程序流程：</p><pre><code class="mermaid">graph LR
a0(加载子域名字典)--&gt;a1(DNS可靠性检测优选)--&gt;a2(泛解析域名检测)--&gt;a3(DNS轮询暴破子域名)--&gt;a4(CNAME记录反查子域名)--&gt;a5(输出结果)
</code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过本次源码分析，学到了：</p><ul><li><p>子域名扫描的步骤和流程</p></li><li><p>DNS服务器可靠性检测判断</p></li><li><p>如何检测一个域名是否为泛解析域名</p></li><li><p>可以优化DNS的筛选步骤，如可以预先对可用DNS进行测速，选择最快的DNS服务器进行查询</p></li><li><p>扫描方法过于单一，只支持暴力查询，可以加入如搜索引擎查询等其他方法使扫描结果更为全面</p></li><li><p>代码存在冗余，优化以后可以更为简洁明了</p></li></ul><p>总的来说这是一款不错的子域名扫描器，速度快也较为精准，但仍然存在可以优化的空间。</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E6%8A%80%E6%9C%AF/" class="category-chain-item">技术</a> <span>></span> <a href="/categories/%E6%8A%80%E6%9C%AF/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" class="category-chain-item">网络安全</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E5%AE%89%E5%85%A8%E5%B7%A5%E5%85%B7/" class="print-no-link">#安全工具</a></div></div><div class="license-box my-3"><div class="license-title"><div>子域名扫描原理与subDomainsBrute源码解析</div><div>https://wanf3ng.github.io/2021/02/02/子域名扫描原理与subDomainsBrute源码解析/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>wanf3ng</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2021年2月2日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2021/02/04/%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0%E7%AE%80%E6%98%93%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F%E8%84%9A%E6%9C%AC/" title="端口扫描原理及实现简易端口扫描脚本"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">端口扫描原理及实现简易端口扫描脚本</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2021/02/01/mysql%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="mysql注入学习笔记"><span class="hidden-mobile">mysql注入学习笔记</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.5.1/Valine.min.js",(function(){var i=Object.assign({appId:"p02g21Pc8PhKfLm9ib0EkgvU-gzGzoHsz",appKey:"WvjDJdcuEIzre37U5HgmMBRy",path:"window.location.pathname",placeholder:"说点什么",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!0,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!0},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var i="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="/js/duration.js"></script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/custom.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>